# Generated by Django 2.2.10 on 2020-05-15 13:23

import django.db.models.deletion
from django.db import migrations, models
from django.db import transaction, connection

from apps.common.sql_commons import fetch_int, SQLClause, dropping_constraints_and_indexes, maintenance_work_mem


def update(apps, schema_editor):
    model_name_prefixes = ['Amount', 'Citation', 'Copyright', 'Court', 'Currency', 'DateDuration',
                           'Date', 'Definition', 'Distance', 'GeoAlias', 'GeoEntity', 'Party',
                           'Percent', 'Ratio', 'Regulation', 'Term', 'Trademark', 'Url']

    print('Filling document_id and project_id columns for ThingUsage tables...')
    i = 0
    with transaction.atomic():
        for model_name_prefix in model_name_prefixes:
            i += 1

            model_name = model_name_prefix + 'Usage'
            model = apps.get_model('extract', model_name)
            table_name = model._meta.db_table

            with connection.cursor() as cursor:
                with maintenance_work_mem(cursor, logger_proc=lambda s: print(s)):
                    count = fetch_int(cursor, SQLClause(f'select count(*) from {table_name}'))
                    print(f'{i} of {len(model_name_prefixes)}: '
                          f'Processing table {table_name} ({model_name}). '
                          f'Will have to update {count} rows...')

                    with dropping_constraints_and_indexes(cursor, table_name, logger_proc=lambda s: print(s)):
                        print(f'Executing the update for {table_name}...')
                        cursor.execute(f'''
update  {table_name} thing_usage
set     document_id = doc.id, project_id = doc.project_id
from    document_textunit tu inner join document_document doc on tu.document_id = doc.id
where   thing_usage.text_unit_id = tu.id
                                ''')
            print(f'{table_name}: done!')


class Migration(migrations.Migration):
    dependencies = [
        ('document', '0200_auto_20200512_1815'),
        ('project', '0040_auto_20200512_1829'),
        ('extract', '0055_project_mat_views'),
    ]

    operations = [
        migrations.AddField(
            model_name='amountusage',
            name='document',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='document.Document'),
        ),
        migrations.AddField(
            model_name='amountusage',
            name='project',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='project.Project'),
        ),
        migrations.AddField(
            model_name='citationusage',
            name='document',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='document.Document'),
        ),
        migrations.AddField(
            model_name='citationusage',
            name='project',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='project.Project'),
        ),
        migrations.AddField(
            model_name='copyrightusage',
            name='document',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='document.Document'),
        ),
        migrations.AddField(
            model_name='copyrightusage',
            name='project',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='project.Project'),
        ),
        migrations.AddField(
            model_name='courtusage',
            name='document',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='document.Document'),
        ),
        migrations.AddField(
            model_name='courtusage',
            name='project',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='project.Project'),
        ),
        migrations.AddField(
            model_name='currencyusage',
            name='document',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='document.Document'),
        ),
        migrations.AddField(
            model_name='currencyusage',
            name='project',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='project.Project'),
        ),
        migrations.AddField(
            model_name='datedurationusage',
            name='document',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='document.Document'),
        ),
        migrations.AddField(
            model_name='datedurationusage',
            name='project',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='project.Project'),
        ),
        migrations.AddField(
            model_name='dateusage',
            name='document',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='document.Document'),
        ),
        migrations.AddField(
            model_name='dateusage',
            name='project',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='project.Project'),
        ),
        migrations.AddField(
            model_name='definitionusage',
            name='document',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='document.Document'),
        ),
        migrations.AddField(
            model_name='definitionusage',
            name='project',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='project.Project'),
        ),
        migrations.AddField(
            model_name='distanceusage',
            name='document',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='document.Document'),
        ),
        migrations.AddField(
            model_name='distanceusage',
            name='project',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='project.Project'),
        ),
        migrations.AddField(
            model_name='geoaliasusage',
            name='document',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='document.Document'),
        ),
        migrations.AddField(
            model_name='geoaliasusage',
            name='project',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='project.Project'),
        ),
        migrations.AddField(
            model_name='geoentityusage',
            name='document',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='document.Document'),
        ),
        migrations.AddField(
            model_name='geoentityusage',
            name='project',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='project.Project'),
        ),
        migrations.AddField(
            model_name='partyusage',
            name='document',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='document.Document'),
        ),
        migrations.AddField(
            model_name='partyusage',
            name='project',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='project.Project'),
        ),
        migrations.AddField(
            model_name='percentusage',
            name='document',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='document.Document'),
        ),
        migrations.AddField(
            model_name='percentusage',
            name='project',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='project.Project'),
        ),
        migrations.AddField(
            model_name='ratiousage',
            name='document',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='document.Document'),
        ),
        migrations.AddField(
            model_name='ratiousage',
            name='project',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='project.Project'),
        ),
        migrations.AddField(
            model_name='regulationusage',
            name='document',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='document.Document'),
        ),
        migrations.AddField(
            model_name='regulationusage',
            name='project',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='project.Project'),
        ),
        migrations.AddField(
            model_name='termusage',
            name='document',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='document.Document'),
        ),
        migrations.AddField(
            model_name='termusage',
            name='project',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='project.Project'),
        ),
        migrations.AddField(
            model_name='trademarkusage',
            name='document',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='document.Document'),
        ),
        migrations.AddField(
            model_name='trademarkusage',
            name='project',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='project.Project'),
        ),
        migrations.AddField(
            model_name='urlusage',
            name='document',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='document.Document'),
        ),
        migrations.AddField(
            model_name='urlusage',
            name='project',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE,
                                    to='project.Project'),
        ),

        migrations.RunPython(update, migrations.RunPython.noop)
    ]
