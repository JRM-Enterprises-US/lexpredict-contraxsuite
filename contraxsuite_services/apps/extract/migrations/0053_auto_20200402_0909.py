# Generated by Django 2.2.10 on 2020-04-02 09:09

from django.db import migrations, connection


def calc_sums(apps, schema_editor):
    with connection.cursor() as cursor:
        cursor.execute('''
        CREATE TEMP TABLE extract_definitionusage_upper 
        (id SERIAL PRIMARY KEY, definition TEXT, text_unit_id INTEGER, count INTEGER);
        INSERT INTO extract_definitionusage_upper (definition, text_unit_id, count)
            SELECT UPPER(definition), text_unit_id, SUM(count)
            FROM extract_definitionusage
            GROUP BY UPPER(definition), text_unit_id;
        DELETE FROM extract_definitionusage;
        ALTER SEQUENCE extract_definitionusage_id_seq RESTART WITH 1;
        INSERT INTO extract_definitionusage (definition, text_unit_id, count)
            SELECT definition, text_unit_id, count FROM extract_definitionusage_upper;
        DROP TABLE extract_definitionusage_upper;
            ''')


def revert_sums(app, schema_editor):
    pass


class Migration(migrations.Migration):
    dependencies = [
        ('extract', '0048_auto_20200323_1702'),
    ]

    operations = [
        migrations.RunPython(calc_sums, reverse_code=revert_sums)
    ]
