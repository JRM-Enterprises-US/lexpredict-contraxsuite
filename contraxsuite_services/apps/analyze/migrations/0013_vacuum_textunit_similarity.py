# Generated by Django 2.2.13 on 2020-06-29 09:30
import datetime

from django.db import migrations, models, connection
import django.db.models.deletion


TABLE_NAME = 'analyze_textunitsimilarity'


def vacuum_textunit_similarity(_apps, schema_editor):
    started = datetime.datetime.now()
    if schema_editor.connection.in_atomic_block:
        schema_editor.atomic.__exit__(None, None, None)

    with connection.cursor() as cursor:
        print(f'Denormalizing t.u.s.: Vacuum analyzing...')
        cursor.execute(f'VACUUM {TABLE_NAME};')
    elapsed = (datetime.datetime.now() - started).total_seconds()
    print(f'Denormalizing t.u.s.: Vacuum analyzing took {elapsed}s')


class Migration(migrations.Migration):

    dependencies = [
        ('analyze', '0012_populate_textunit_similarity_fields'),
    ]

    operations = [
        migrations.RunPython(vacuum_textunit_similarity, reverse_code=migrations.RunPython.noop),
    ]
