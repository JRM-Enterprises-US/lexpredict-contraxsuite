# -*- coding: utf-8 -*-
# Generated by Django 1.11.3 on 2018-04-01 07:39
from __future__ import unicode_literals
from django.db import migrations, connection
from django.db.models import Manager

from apps.document import constants
from apps.document.models import DocumentType as DocumentTypeClass


def create_generic_document_type(apps, schema_editor):
    Document = apps.get_model('document', 'Document')
    DocumentType = apps.get_model('document', 'DocumentType')
    obj, _ = DocumentType.objects.get_or_create(uid=constants.DOCUMENT_TYPE_PK_GENERIC_DOCUMENT, defaults={
                'uid': constants.DOCUMENT_TYPE_PK_GENERIC_DOCUMENT,
                'code': DocumentTypeClass.GENERIC_TYPE_CODE,
                'title': 'Generic Document'})
    with connection.cursor() as cursor:
        cursor.execute(f'''UPDATE project_project SET type_id = '{obj.pk}'
                           WHERE type_id is null; ''')
    Document.objects.filter(document_type__isnull=True).update(document_type=obj)


class Migration(migrations.Migration):
    dependencies = [
        ('document', '0033_auto_20180401_0739'),
    ]

    operations = [
        migrations.AlterModelManagers(
            name='document',
            managers=[('objects', Manager(),)],
        ),
        migrations.RunPython(create_generic_document_type),
    ]
